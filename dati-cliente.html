<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Step 2 - Raccolta Dati del tuo Cliente a cui stai Noleggiando</title>
 <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
    }
    h2 {
      color: #333;
    }
    .container {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
      max-width: 800px;
      margin: auto;
    }
    .grid-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 20px;
    }
    input, button {
      padding: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background-color: green;
      color: white;
      border: none;
      cursor: pointer;
      padding: 10px;
    }
    button:hover {
      background-color: darkgreen;
    }
    .error {
      color: red;
      font-weight: bold;
      grid-column: 1 / 3;
    }
   .back-btn {
    background-color: gray;
    color: white;
    margin: 20px auto; /* Centra il bottone */
    display: block; /* Imposta il bottone come elemento a blocco per centrarlo */
    width: 100%; /* Larghezza totale del bottone */
    max-width: 200px; /* Limita la larghezza massima */
    text-align: center; /* Centra il testo all'interno del bottone */
    padding: 10px; /* Spaziatura interna per rendere il bottone più uniforme */
    border-radius: 5px; /* Bordo arrotondato per migliorare l'aspetto */
    cursor: pointer;
}

    .back-btn:hover {
      background-color: darkgray;
    }
    .ratei-section {
      margin-bottom: 30px;
      text-align: center;
      padding: 15px;
      background-color: #eee;
      border-radius: 5px;
    }
    .ratei-section h3 {
      margin: 0;
      margin-bottom: 10px;
      font-size: 20px;
    }
    .ratei-value {
      font-size: 24px;
      font-weight: bold;
    }
    .hidden {
      display: none;
    }
    .ricarico-container {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin-bottom: 15px;
    }
    .ricarico-container label {
      margin-right: 10px;
    }
    .ricarico-container input[type="radio"] {
      margin-left: 10px;
      margin-right: 5px;
    }
    #valore-ricarico {
      width: 150px;
    }
    .radio-wrapper {
      display: flex;
      align-items: center;
      justify-content: space-around;
      width: 100%;
    }
    .ricarico-options {
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }
    .apply-ricarico {
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }
    .apply-ricarico label {
      margin-right: 10px;
    }
    .apply-ricarico input[type="number"] {
      text-align: center;
    }

    button:disabled {
  background-color: grey;
  cursor: not-allowed;
}
#invia-dati {
  background-color: grey;
  color: white;
}


    /* Aggiunta margine sotto al campo N° di cellulare */
    #cellulare-firmatario {
      margin-bottom: 20px;
    }

    /* Nuova classe per i campi con errori */
    .input-error {
      border: 2px solid red;
      box-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
    }

/* Stili per la finestra modale */
.modal {
    display: none; 
    position: fixed; 
    z-index: 1; 
    left: 0;
    top: 0;
    width: 100%; 
    height: 100%; 
    overflow: auto; 
    background-color: rgb(0,0,0); 
    background-color: rgba(0,0,0,0.4); 
}

.modal-content {
    background-color: #fefefe;
    margin: 15% auto; 
    padding: 20px;
    border: 1px solid #888;
    width: 80%; 
    max-width: 600px; 
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}
.upload-section {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
}

.upload-container {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    padding: 10px;
}

.upload-container label {
    margin-bottom: 0; /* Rimuove il margine inferiore */
    text-align: left; /* Allinea il testo a sinistra */
    width: 50%;
}

.upload-container input[type="file"] {
    width: 50%;
}

#upload-docs {
    position: relative;
    margin-top: 10px !important;
    margin-bottom: 10px; /* Aggiungi questo per bilanciare il posizionamento */
}
#upload-docs::after {
    content: attr(data-doc-count);
    background-color: red;
    color: white;
    border-radius: 50%;
    padding: 2px 6px;
    font-size: 12px;
    position: absolute;
    top: -5px;
    right: -5px;
    display: none;
}

#upload-docs[data-doc-count="0"]::after {
    display: none;
}

#upload-docs[data-doc-count]:not([data-doc-count="0"])::after {
    display: inline-block;
}

.back-btn {
    background-color: gray;
    color: white;
    margin: 10px 0 10px 10px; /* Posiziona in alto a sinistra */
    display: inline-block;
    padding: 5px 15px;
    border-radius: 5px;
    cursor: pointer;
}
.back-btn:hover {
    background-color: green;
}

</style>


</head>
<body>
  <div class="container">

<button id="back-to-rentCalc" class="back-btn">Torna a Modifica</button>
    
<div class="ratei-section">
      <h3>Totale Noleggio: <span id="totale-ratei">0,00 €</span></h3>
      <div class="radio-wrapper">
        <div class="ricarico-options">
          <label for="ricarico-percentuale"><input type="radio" id="ricarico-percentuale" name="ricarico" value="percentuale" checked> In Percentuale</label>
          <label for="ricarico-valore"><input type="radio" id="ricarico-valore" name="ricarico" value="valore"> Valore Fisso</label>
        </div>
        <div class="apply-ricarico">
          <label for="valore-ricarico">Applica il tuo ricarico:</label>
          <input type="number" id="valore-ricarico" placeholder="Inserisci il ricarico">
        </div>
      </div>
      <p>Durata in mesi: 
        <select id="durata-mesi">
          <option value="">Seleziona</option>
          <option value="24">24 mesi</option>
          <option value="30">30 mesi</option>
          <option value="36">36 mesi</option>
          <option value="48">48 mesi</option>
          <option value="60">60 mesi</option>
        </select>
      </p>
      <p>La rata mensile applicata è di: <span class="ratei-value" id="rata-mensile">0,00 €</span></p>
      <button id="applica-ratei" disabled>Applica</button>
    </div>
    <div id="dati-cliente-section" class="hidden">
      <h2>Raccolta Dati del tuo Cliente a cui stai Noleggiando</h2>
      <div class="grid-container">
     <div>
  <label for="ragione-sociale">RAGIONE SOCIALE:</label>
  <input type="text" id="ragione-sociale" name="ragione-sociale" maxlength="255" pattern="^[a-zA-Z0-9\s]+$" required>
  <div class="error-message" id="ragione-sociale-error" style="display:none;"></div>
</div>
        <div>
          <label for="piva-cliente">P.IVA:</label>
          <input type="text" id="piva-cliente" name="piva-cliente" minlength="11" maxlength="11" pattern="\d{11}" required>
        </div>
        <div>
          <label for="indirizzo-consegna">INDIRIZZO DI CONSEGNA DEL BENE:</label>
          <input type="text" id="indirizzo-consegna" name="indirizzo-consegna" maxlength="80"  required>
        </div>
        <div>
          <label for="pec-cliente">PEC:</label>
          <input type="email" id="pec-cliente" name="pec-cliente" required>
        </div>
        <div>
          <label for="sdi-cliente">SDI:</label>
          <input type="text" id="sdi-cliente" name="sdi-cliente" minlength="7" maxlength="7" pattern="^[a-zA-Z0-9]+$" required>
        </div>
        <div>
          <label for="nome-firmatario">NOME DEL FIRMATARIO:</label>
          <input type="text" id="nome-firmatario" name="nome-firmatario" maxlength="50" pattern="^[a-zA-Z\s]+$" required>
        </div>
        <div>
          <label for="cognome-firmatario">COGNOME DEL FIRMATARIO:</label>
          <input type="text" id="cognome-firmatario" name="cognome-firmatario" maxlength="50" pattern="^[a-zA-Z\s]+$" required>
        </div>
        <div>
          <label for="email-firmatario">INDIRIZZO MAIL:</label>
          <input type="email" id="email-firmatario" name="email-firmatario" required>
        </div>
        <div>  
  <label for="cellulare-firmatario">N° DI CELLULARE:</label>  
  <input type="tel" id="cellulare-firmatario" name="cellulare-firmatario" minlength="9" pattern="\d{9,}" required>
</div>
<div class="upload-container">
  <button id="upload-docs">Carica ora i Documenti del tuo cliente</button>
</div>
<div id="myModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div class="upload-container">
            <label for="visura">Visura Camerale emessa da meno di sei mesi (max 3mb):</label>
            <input type="file" id="visura" name="visura" accept=".pdf,.jpg" data-max-size="3072">
        </div>
        <div class="upload-container">
            <label for="documento-rappresentante">Documento Rappresentante Legale (max 3mb):</label>
            <input type="file" id="documento-rappresentante" name="documento-rappresentante" accept=".pdf,.jpg" data-max-size="3072">
        </div>
        <div class="upload-container">
            <label for="bilancio">Ultimo Bilancio Utile (max 3mb):</label>
            <input type="file" id="bilancio" name="bilancio" accept=".pdf,.jpg" data-max-size="3072">
        </div>
        <div class="upload-container">
            <button id="upload-confirm">Carica</button>
        </div>
    </div>
</div>
</div>

        <p class="error" id="error-message" style="display:none;"></p>
      </div>
      <button id="invia-dati">Prosegui Richiesta</button>
    </div>
   <!-- <button id="back-btn" class="back-btn">Reset</button> -->
  </div>

<script>

document.addEventListener('DOMContentLoaded', function() {


    const valoreRicarico = localStorage.getItem('valoreRicarico');
    let durataMesi = '';
    const totaleNoleggio = localStorage.getItem('totaleProdotti') || '0,00';
    const prodotti = JSON.parse(localStorage.getItem('prodotti')) || [];
    const importoRata = localStorage.getItem('importoRata') || '0,00';

    // Imposta i valori recuperati nei campi del modulo
    if (valoreRicarico) {
        document.getElementById('valore-ricarico').value = valoreRicarico;
    }
    if (durataMesi) {
        document.getElementById('durata-mesi').value = durataMesi;
    }

    document.getElementById('totale-ratei').textContent = totaleNoleggio + ' €';
    
    const bottoneProsegui = document.getElementById('invia-dati');
    bottoneProsegui.style.backgroundColor = 'grey';

    function aggiornaColoreProsegui() {
        bottoneProsegui.style.backgroundColor = bottoneProsegui.disabled ? 'grey' : 'green';
    }
    
    aggiornaColoreProsegui();

// Assicura che il bottone parta disabilitato e grigio
bottoneProsegui.disabled = true;
aggiornaColoreProsegui();


// Funzione per gestione click del bottone "Prosegui Richiesta"
bottoneProsegui.addEventListener('click', function () {
    if (!bottoneProsegui.disabled) { // Procede solo se abilitato
        localStorage.setItem('totaleProdotti', calcolaRicarico().toFixed(2));
        localStorage.setItem('numeroRate', document.getElementById('durata-mesi').value);
        localStorage.setItem('importoRata', document.getElementById('rata-mensile').textContent);
        window.location.href = "Finale.html"; // Navigazione finale
    }
});

// Aggiungi listener per monit


// Funzione per verificare se tutti i campi richiesti sono compilati correttamente
function verificaCampiCompilati() {
    const campiRichiesti = [
        'ragione-sociale', 'piva-cliente', 'indirizzo-consegna', 'pec-cliente',
        'sdi-cliente', 'nome-firmatario', 'cognome-firmatario', 'email-firmatario', 'cellulare-firmatario'
    ];

    // Verifica che ogni campo sia popolato e non abbia errori
    const tuttiCompilati = campiRichiesti.every(id => {
        const campo = document.getElementById(id);
        return campo.value.trim() !== '' && !campo.classList.contains('input-error');
    });

    // Abilita/disabilita il pulsante "Prosegui Richiesta" in base ai risultati
    bottoneProsegui.disabled = !tuttiCompilati;
    aggiornaColoreProsegui(); // Aggiorna il colore del bottone
}

// Aggiungi listener di input a ciascun campo richiesto per verificare quando tutti sono completati
document.querySelectorAll('#dati-cliente-section input[required]').forEach(input => {
    input.addEventListener('input', verificaCampiCompilati);
});


// Funzione per il controllo della dimensione massima dei file
// Funzione per il controllo della dimensione massima dei file
function controlloDimensioneFile(fileInput) {
    const maxSize = fileInput.getAttribute('data-max-size') * 1024; // Converti in byte
    const files = fileInput.files;

    for (let i = 0; i < files.length; i++) {
        if (files[i].size > maxSize) {
            alert(`Il file "${files[i].name}" supera la dimensione massima di 3 MB.`);
            fileInput.value = ""; // Reset del campo file
            return false;
        }
    }
    return true;
}

// Contatore per mostrare il numero di documenti caricati
function aggiornaBadgeCaricamento() {
    const fileInputs = document.querySelectorAll('.upload-container input[type="file"]');
    let fileCount = 0;

    fileInputs.forEach(input => {
        if (input.files.length > 0) fileCount++;
    });

// Funzione di conversione file in Base64 e salvataggio in sessionStorage
function salvaFileInSessionStorage(fileInput) {
    console.log(`Tentativo di salvare il file con ID: ${fileInput.id}`); // Log iniziale
    const file = fileInput.files[0];
    if (!file) {
        console.log("Nessun file selezionato.");
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const base64File = e.target.result.split(',')[1]; // Ottieni solo i dati Base64
        console.log(`Contenuto Base64 del file ${fileInput.id}:`, base64File); // Log per verificare il contenuto Base64
        sessionStorage.setItem(fileInput.id, base64File); // Salva il file in sessionStorage
        console.log(`File ${fileInput.id} salvato in sessionStorage con valore Base64: ${sessionStorage.getItem(fileInput.id)}`);
    };
    reader.readAsDataURL(file);
}


// Aggiungi l’evento di caricamento su ogni input file
document.getElementById('visura').addEventListener('change', function() {
    console.log("Evento change rilevato per il file 'Visura'");
    salvaFileInSessionStorage(this);
});

document.getElementById('documento-rappresentante').addEventListener('change', function() {
    console.log("Evento change rilevato per il file 'Documento Rappresentante'");
    salvaFileInSessionStorage(this);
});

document.getElementById('bilancio').addEventListener('change', function() {
    console.log("Evento change rilevato per il file 'Bilancio'");
    salvaFileInSessionStorage(this);
});

    // Aggiorna il badge sul bottone
    document.getElementById('upload-docs').setAttribute('data-doc-count', fileCount);
}

// Aggiungi listener su ciascun input file per aggiornare il badge e controllare la dimensione
// Rimuove il conteggio immediato dal cambio file
document.querySelectorAll('.upload-container input[type="file"]').forEach(input => {
    input.addEventListener('change', function() {
        controlloDimensioneFile(this); // Mantiene il controllo della dimensione
    });
});

// Listener per il bottone di conferma caricamento
document.getElementById('upload-confirm').addEventListener('click', function() {
    document.getElementById('myModal').style.display = 'none';
    aggiornaBadgeCaricamento(); // Aggiorna il badge solo al clic di "Carica"
    console.log("Contenuto di sessionStorage dopo il caricamento:", sessionStorage); // Nuovo log per controllo
});

// ---- Inizio del blocco per la gestione della finestra modale ----
document.getElementById('upload-docs').addEventListener('click', function() {
    document.getElementById('myModal').style.display = 'block';
});

// Chiudi la finestra modale quando si clicca sulla "X"
document.querySelector('.close').addEventListener('click', function() {
    document.getElementById('myModal').style.display = 'none';
});

// Chiudi la finestra modale quando si clicca fuori dalla finestra stessa
window.addEventListener('click', function(event) {
    if (event.target === document.getElementById('myModal')) {
        document.getElementById('myModal').style.display = 'none';
    }
});
// ---- Fine del blocco per la gestione della finestra modale ----


document.getElementById('visura').addEventListener('change', function() {
    controlloDimensioneFile(this);
});
document.getElementById('documento-rappresentante').addEventListener('change', function() {
    controlloDimensioneFile(this);
});
document.getElementById('bilancio').addEventListener('change', function() {
    controlloDimensioneFile(this);
});



// Funzione per abilitare/disabilitare il bottone "Applica" quando ci sono valori validi per ricarico e durata
function abilitaBottoneApplica() {
    const valoreRicarico = document.getElementById('valore-ricarico').value;
    const durataMesi = document.getElementById('durata-mesi').value;

    // Abilita il bottone "Applica" solo se entrambi i valori sono presenti e validi
    document.getElementById('applica-ratei').disabled = !(valoreRicarico && durataMesi);
}

// Collega la funzione abilitaBottoneApplica agli eventi input e change
document.getElementById('valore-ricarico').addEventListener('input', abilitaBottoneApplica);
document.getElementById('durata-mesi').addEventListener('change', abilitaBottoneApplica);
document.getElementById('applica-ratei').addEventListener('click', function() {
    document.getElementById('dati-cliente-section').classList.remove('hidden');
    aggiornaColoreProsegui();
});
}); // Fine del blocco DOMContentLoaded

// Funzione per calcolare il ricarico in base alla selezione dell'utente  
function calcolaRicarico() {
    const totaleNoleggio = parseFloat(localStorage.getItem('totaleProdotti')) || 0;
    let ricarico = parseFloat(document.getElementById('valore-ricarico').value) || 0;
    let totaleConRicarico;

    if (document.getElementById('ricarico-percentuale').checked) {
      totaleConRicarico = totaleNoleggio + (totaleNoleggio * (ricarico / 100));
    } else {
      totaleConRicarico = totaleNoleggio + ricarico;
    }

    return totaleConRicarico;
}

// Funzione per calcolare la rata mensile
function calcolaRata(totaleConRicarico, durataMesi) {
    const coefficienti = {
      24: [4.82, 4.817, 4.774, 4.766, 4.691, 4.631],
      30: [3.869, 3.851, 3.820, 3.795, 3.778, 3.735],
      36: [3.457, 3.367, 3.300, 3.277, 3.240, 3.236],
      48: [2.895, 2.579, 2.550, 2.518, 2.516, 2.513],
      60: [2.499, 2.155, 2.119, 2.089, 2.056, 1.996]
    };

    let fascia;
    if (totaleConRicarico <= 2500) {
      fascia = 0;
    } else if (totaleConRicarico <= 5000) {
      fascia = 1;
    } else if (totaleConRicarico <= 12000) {
      fascia = 2;
    } else if (totaleConRicarico <= 25000) {
      fascia = 3;
    } else if (totaleConRicarico <= 50000) {
      fascia = 4;
    } else {
      fascia = 5;
    }

    let coefficiente = coefficienti[durataMesi][fascia] || 0;
    let rataMensile = (totaleConRicarico * coefficiente) / 100;
    return rataMensile.toFixed(2);
}

function aggiornaCalcolo() {
    let totaleConRicarico = calcolaRicarico();
    document.getElementById('totale-ratei').textContent = totaleConRicarico.toFixed(2) + ' €';

    // Recupera la durata mesi dall'input selezionato dall'utente
    let durataMesi = document.getElementById('durata-mesi').value;

    // Esegui il calcolo solo se una durata è stata selezionata manualmente
    if (durataMesi && durataMesi !== '') {
        let rataMensile = calcolaRata(totaleConRicarico, durataMesi);
        document.getElementById('rata-mensile').textContent = rataMensile + ' €';
    } else {
        // Se non è selezionata, imposta rata e durata a valori di avvio
        document.getElementById('rata-mensile').textContent = '0,00 €';
        document.getElementById('durata-mesi').value = ''; // Assicura campo vuoto all'avvio
    }
}



document.getElementById('valore-ricarico').addEventListener('input', aggiornaCalcolo);
document.getElementById('durata-mesi').addEventListener('change', aggiornaCalcolo);

document.querySelectorAll('input[name="ricarico"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
        const valoreRicarico = document.getElementById('valore-ricarico');
        valoreRicarico.classList.add('input-error');
        setTimeout(() => valoreRicarico.classList.remove('input-error'), 1000);
        aggiornaCalcolo();
    });
});

// Funzione per validare i campi del cliente
function validaCampiCliente() {
    // Esempio di semplice validazione per un campo obbligatorio
    const campiDaValidare = [
        'ragione-sociale',
        'piva-cliente',
        'indirizzo-consegna',
        'pec-cliente',
        'sdi-cliente',
        'nome-firmatario',
        'cognome-firmatario',
        'email-firmatario',
        'cellulare-firmatario'
    ];

    let tuttiValidi = true;

    campiDaValidare.forEach(id => {
        const campo = document.getElementById(id);
        if (campo && campo.value.trim() === '') {
            campo.classList.add('input-error'); // aggiunge una classe di errore visiva
            tuttiValidi = false;
        } else {
            campo.classList.remove('input-error'); // rimuove l'errore se valido
        }
    });

    return tuttiValidi;
}

document.getElementById('invia-dati').addEventListener('click', function() {
    if (validaCampiCliente()) {
        localStorage.setItem('totaleProdotti', calcolaRicarico().toFixed(2));
        localStorage.setItem('numeroRate', document.getElementById('durata-mesi').value);
        localStorage.setItem('importoRata', document.getElementById('rata-mensile').textContent);
        window.location.href = "Finale.html";
    } else {
        document.getElementById('error-message').textContent = 'Compila tutti i campi correttamente prima di proseguire.';
        document.getElementById('error-message').style.display = 'block';
    }
});
// Funzione per mostrare o nascondere i messaggi di errore e aggiungere effetto "blur rosso"
function mostraErrore(idCampo, condizione) {
    if (condizione) {
        document.getElementById(idCampo).classList.add('input-error');
    } else {
        document.getElementById(idCampo).classList.remove('input-error');
    }
}

// Validazione campi cliente
function validaCampo(idCampo, pattern, minLength = 0) {
    const campo = document.getElementById(idCampo);
    campo.addEventListener('input', function() {
      const valore = this.value;
      const condizioneErrore = valore.length < minLength || !pattern.test(valore);
      mostraErrore(idCampo, condizioneErrore);
    });

    campo.addEventListener('blur', function() {
      const valore = this.value;
      const condizioneErrore = valore.length < minLength || !pattern.test(valore);
      mostraErrore(idCampo, condizioneErrore);
    })
}

// Applicare la validazione a ciascun campo specifico
validaCampo('ragione-sociale', /^[a-zA-Z0-9\s]+$/, 5);
validaCampo('piva-cliente', /^\d{11}$/, 11);
validaCampo('indirizzo-consegna', /^[a-zA-Z0-9\s]+$/, 5);
validaCampo('pec-cliente', /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/, 5);
validaCampo('sdi-cliente', /^[a-zA-Z0-9]{7}$/, 7);
validaCampo('nome-firmatario', /^[a-zA-Z\s]+$/, 2);
validaCampo('cognome-firmatario', /^[a-zA-Z\s]+$/, 2);
validaCampo('email-firmatario', /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/, 5);
validaCampo('cellulare-firmatario', /^\d{9,}$/, 9);

// Aggiungi il gestore per il bottone "Torna a Modifica"
document.getElementById('back-to-rentCalc').addEventListener('click', function() {
    window.history.back(); // Torna alla pagina precedente
});

</script>

</body>
</html>